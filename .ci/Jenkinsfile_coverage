#!/bin/groovy

library 'kibana-pipeline-library'
kibanaLibrary.load() // load from the Jenkins instance

kibanaPipeline(timeoutMinutes: 240) {
  catchErrors {
    withEnv([
      'CODE_COVERAGE=1', // Enables coverage.  Needed for multiple ci scripts, such as remote.ts, test/scripts/*.sh, schema.js, etc.
    ]) {
      workers.base(name: 'coverage-worker', size: 'l', ramDisk: false, bootstrapped: false) {
        handlePrevious()
        kibanaCoverage.runTests()
        handleInjestion()
      }
    }
    kibanaPipeline.sendMail()
  }
}

def handleInjestion() {
  kibanaPipeline.downloadCoverageArtifacts()
  kibanaCoverage.injestAndUpload('### Injest && Upload')
}

def handlePrevious() {
  kibanaCoverage.downloadPrevious('### Download OLD Previous')
  kibanaCoverage.collectVcsInfo('### Collect NEW VCS Info')
  kibanaCoverage.uploadPrevious('### Upload NEW Previous')
}
